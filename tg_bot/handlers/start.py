import base64

from aiogram import Dispatcher, types
from aiogram.dispatcher import FSMContext

from database.functions.group_members import add_user_db
from database.functions.user import create_user, get_user_by_tg_id


def decode_group_id(encoded_str: str) -> int:
    padding = "=" * (4 - len(encoded_str) % 4)
    encoded_str += padding
    encoded_bytes = encoded_str.encode("utf-8")
    group_id_bytes = base64.urlsafe_b64decode(encoded_bytes)
    group_id_str = group_id_bytes.decode("utf-8")
    return int(group_id_str)


async def start_message(message: types.Message, state: FSMContext):
    user = get_user_by_tg_id(message.from_user.id)
    keyboard = types.InlineKeyboardMarkup()
    button = types.InlineKeyboardButton(
        text="–û—Ç–∫—Ä—ã—Ç—å Web App", url="t.me/{{sensitive_data}}/Diwy"
    )
    keyboard.add(button)
    if user is None:
        create_user(
            tg_id=message.from_user.id,
            name=message.from_user.full_name,
            card_number=None,
        )

        args = message.get_args()
        if args:
            # print(str(args))
            group_id = decode_group_id(args)
            add_user_db(message.from_user.id, int(group_id))

            await message.answer(
                "–ü—Ä–∏–≤–µ—Ç! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Diwy ‚Äì –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±—â–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏!\n\n–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–æ—â–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ. –¢–µ–ø–µ—Ä—å –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å—Å—è –æ —Ç–æ–º, –∫—Ç–æ –∑–∞ —á—Ç–æ –ø–ª–∞—Ç–∏–ª –∏ –∫–æ–º—É —á—Ç–æ –¥–æ–ª–∂–µ–Ω. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—á—ë—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç, –∫—Ç–æ –∫–æ–º—É —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–µ–Ω.\n\n–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –±–æ—Ç–∞:\n\nüí∞ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –∏–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏.\nüìä –û—Ç–º–µ—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.\n‚úàÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.\nüîç –ü–æ–ª—É—á–∞—Ç—å —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–æ–º—É –∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –¥–æ–ª–∂–Ω—ã, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç."
            )
            await message.answer(
                "–í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É –∏ —è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª –í–∞—Å!",
                reply_markup=keyboard,
            )
        else:
            await message.answer(
                "–ü—Ä–∏–≤–µ—Ç! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Diwy ‚Äì –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±—â–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏!\n\n–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–æ—â–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ. –¢–µ–ø–µ—Ä—å –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å—Å—è –æ —Ç–æ–º, –∫—Ç–æ –∑–∞ —á—Ç–æ –ø–ª–∞—Ç–∏–ª –∏ –∫–æ–º—É —á—Ç–æ –¥–æ–ª–∂–µ–Ω. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—á—ë—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç, –∫—Ç–æ –∫–æ–º—É —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–µ–Ω.\n\n–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –±–æ—Ç–∞:\n\nüí∞ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –∏–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏.\nüìä –û—Ç–º–µ—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.\n‚úàÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.\nüîç –ü–æ–ª—É—á–∞—Ç—å —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–æ–º—É –∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –¥–æ–ª–∂–Ω—ã, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.",
                reply_markup=keyboard,
            )

    else:
        args = message.get_args()
        # print(message)

        if args:
            print(str(args))
            group_id = decode_group_id(args)
            group_id = decode_group_id(args)
            add_user_db(message.from_user.id, int(group_id))

            await message.answer(
                "–ü—Ä–∏–≤–µ—Ç! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Diwy ‚Äì –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±—â–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏!\n\n–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–æ—â–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ. –¢–µ–ø–µ—Ä—å –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å—Å—è –æ —Ç–æ–º, –∫—Ç–æ –∑–∞ —á—Ç–æ –ø–ª–∞—Ç–∏–ª –∏ –∫–æ–º—É —á—Ç–æ –¥–æ–ª–∂–µ–Ω. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—á—ë—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç, –∫—Ç–æ –∫–æ–º—É —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–µ–Ω.\n\n–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –±–æ—Ç–∞:\n\nüí∞ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –∏–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏.\nüìä –û—Ç–º–µ—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.\n‚úàÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.\nüîç –ü–æ–ª—É—á–∞—Ç—å —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–æ–º—É –∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –¥–æ–ª–∂–Ω—ã, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç."
            )
            await message.answer(
                "–í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É –∏ —è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª –í–∞—Å!",
                reply_markup=keyboard,
            )
        else:
            await message.answer(
                "–ü—Ä–∏–≤–µ—Ç! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Diwy ‚Äì –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ–±—â–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏!\n\n–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–æ—â–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ. –¢–µ–ø–µ—Ä—å –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å—Å—è –æ —Ç–æ–º, –∫—Ç–æ –∑–∞ —á—Ç–æ –ø–ª–∞—Ç–∏–ª –∏ –∫–æ–º—É —á—Ç–æ –¥–æ–ª–∂–µ–Ω. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã, –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—á—ë—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç, –∫—Ç–æ –∫–æ–º—É —Å–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–µ–Ω.\n\n–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –±–æ—Ç–∞:\n\nüí∞ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∏ –¥–µ–ª–∏—Ç—å—Å—è –∏–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏.\nüìä –û—Ç–º–µ—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.\n‚úàÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.\nüîç –ü–æ–ª—É—á–∞—Ç—å —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–æ–º—É –∏ —Å–∫–æ–ª—å–∫–æ –≤—ã –¥–æ–ª–∂–Ω—ã, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.",
                reply_markup=keyboard,
            )


def register_start_handlers(dp: Dispatcher):
    dp.register_message_handler(start_message, commands=["start"])
